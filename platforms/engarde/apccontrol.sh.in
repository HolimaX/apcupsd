#!@SCRIPTSHELL@
#
# Copyright (C) 1999-2002 Riccardo Facchetti <riccardo@master.oasi.gpa.it>
#
#  for apcupsd release @VERSION@ (@DATE@) - @DISTNAME@
#
# @configure_input@
#
#
# These variables are needed for set up the autoconf other variables.
#
prefix=@prefix@
exec_prefix=@exec_prefix@

APCPID=@PIDDIR@/apcupsd.pid
APCUPSD=@sbindir@/apcupsd
SHUTDOWN=/sbin/shutdown
SCRIPTSHELL=@SCRIPTSHELL@
SCRIPTDIR=@sysconfdir@

#
# Concatenate all output from this script to the events file
#
exec >>@LOGDIR@/apcupsd.events 2>&1

#
# This piece is to substitute the default behaviour with your own script,
# perl, or C program.
# You can customize every single command creating an executable file (may be a
# script or a compiled program) and calling it the same as the $1 parameter
# passed by apcupsd to this script.
#
# After executing your script, apccontrol continues with the default action.
# If you do not want apccontrol to continue, exit your script with exit 
# code 99. E.g. "exit 99".
#
# WARNING: the apccontrol file will be overwritten every time you update your
# apcupsd, doing `make install'. Your own customized scripts will _not_ be
# overwritten. If you wish to make changes to this file (discouraged), you
# should change apccontrol.sh.in and then rerun the configure process.
#
if [ -f ${SCRIPTDIR}/${1} -a -x ${SCRIPTDIR}/${1} ]
then
        ${SCRIPTDIR}/${1} ${2} ${3} ${4}
        # exit code 99 means he does not want us to do default action
        if [ $? = 99 ] ; then
                exit 0
        fi
fi

case "$1" in
        killpower)
                echo "Apccontrol doing: ${APCUPSD} --killpower on UPS ${2}"
                wall "Apccontrol doing: ${APCUPSD} --killpower on UPS ${2}"
                ${APCUPSD} --killpower
        ;;
        commfailure)
                wall "Warning communications lost with UPS ${2}"
        ;;
        commok)
                wall "Communciations restored with UPS ${2}"
        ;;
        powerout)
                wall "Warning power loss detected with UPS ${2}"
        ;;
        onbattery)
                wall "Power failure on UPS ${2}. Running on batteries."
        ;;
        failing)
                wall "Battery power exhaused on UPS ${2}. Doing shutdown."
        ;;
        timeout)
                wall "Battery time limit exceded on UPS ${2}. Doing shutdown."
        ;;
        loadlimit)
                wall "Remaining battery charge below limit on UPS ${2}. Doing shutdown."
        ;;
        runlimit)
                wall "Remaining battery runtime below limit on UPS ${2}. Doing shutdown."
        ;;
        doreboot)
                wall "UPS ${2} initiating Reboot Sequence"
                ${SHUTDOWN} -r now "apcupsd UPS ${2} initiated reboot"
        ;;
        doshutdown)
                wall "UPS ${2} initiated Shutdown Sequence"
                ${SHUTDOWN} -h now "apcupsd UPS ${2} initiated shutdown"
        ;;
        mainsback)
                wall "Power has returned on UPS ${2}..."
                if [ -f @PWRFAILDIR@/powerfail ] ; then
                   wall "Attempting to cancel shutdown."
                   ${SHUTDOWN} -c
                   ${SHUTDOWN} -r now "apcupsd initiated reboot"
                fi
        ;;
        annoyme)
                wall "Power problems with UPS {2}. Please logoff."
        ;;
        emergency)
                wall "Emergency Shutdown. Possible battery failure on UPS ${2}."
                ${SHUTDOWN} -h now "apcupsd emergency shutdown"
        ;;
        changeme)
                wall "Emergency! Batteries have failed on UPS ${2}. Change them NOW"
        ;;
        remotedown)
                wall "Remote Shutdown. Beginning Shutdown Sequence."
                ${SHUTDOWN} -h now "apcupsd remote shutdown"
        ;;
        restartme)
                echo -n "Restarting APCUPSD Power Management: "
                THEPID=`cat ${APCPID}`
                kill ${THEPID}
                rm -f ${APCPID}
                rm -f @PWRFAILDIR@/powerfail
                rm -f @nologdir@/nologin
                sleep 5
                `${APCUPSD}`
                echo "apcupsd"
        ;;
        startselftest)
        ;;
        endselftest)
        ;;
        *)      echo "Usage: ${0##*/} command"
                echo "       warning: this script is intended to be launched by"
                echo "       apcupsd and should never be launched by users."
                exit 1
        ;;
esac
