#! /bin/sh
#
# apcupsd      This shell script takes care of starting and stopping
#              the apcupsd UPS monitoring daemon.
#
# description: apcupsd monitors power and takes action if necessary
#
APCPID=/etc/apcupsd/apcupsd.pid
DISTVER=SCO
return=" Done."

case "$1" in
    start)
        rm -f /etc/apcupsd/powerfail
        if [ -f ${APCPID} ]; then
            echo "Warning: apcupsd power management already running."
        else
            echo "Starting apcupsd power management ...\c"
            /etc/apcupsd/sbin/apcupsd || return=" Failed."
            echo "$return"
        fi
    ;;
    stop)
        if [ -f ${APCPID} ]; then
            echo "Stopping apcupsd power management ...\c"
            THEPID=`cat ${APCPID}`
            kill ${THEPID} || return=" Failed."
            rm -f ${APCPID}
            echo "$return"
        else
            echo "Warning: apcupsd power management not running."
        fi
        if [ -f /etc/apcupsd/powerfail ]; then
            return=" Done."
            echo "Power failure, attempting to shut down UPS ...\c"
            /etc/apcupsd/sbin/apcupsd --killpower || return=" Failed."
            echo "$return"
        fi
    ;;
    restart)
        if [ -f /etc/apcupsd/powerfail ]; then
          echo "Power failure condition set, resolve before attempting restart."
            exit 1
        fi
        $0 stop
        $0 start
    ;;
    status)
        if [ -f ${APCPID} ]; then
            echo "apcupsd power management running."
        else
            echo "apcupsd power management not running."
        fi
        if [ -f /etc/apcupsd/powerfail ]; then
            echo "Power failure condition set."
        else
            echo "Power failure condition normal."
        fi
    ;;
    upsstatus)
       /etc/apcupsd/sbin/apcaccess status
    ;;
    *)
    echo "Usage: $0 {start|stop|restart|status|upsstatus}"
    exit 1
esac

exit 0

