#
# Makefile for win32 apcupsd executables
# Using MinGW cross-compiler on GNU/Linux
#  
#  Modified from Bacula Makefile.in for apcupsd
#   Kern Sibbald, April 2006
# 

# Configuration

TOPDIR = @TOP_DIR@
CROSSTOOLS = $(TOPDIR)/cross-tools
MINGW = $(CROSSTOOLS)/mingw32
INCLUDE_MINGW = -I $(MINGW)/mingw32/include
INCLUDE_GCC = -I $(MINGW)/lib/gcc/mingw32/3.4.5/include

DEPKGS = $(TOPDIR)/depkgs-win32

INCLUDE_APC = -I ../../include -I ./compat
INCLUDE_PTHREADS = -I $(DEPKGS)/pthreads
INCLUDE_ICONS = -I .

LIB_MINGW = $(MINGW)/mingw32/lib
LIB_PTHREADS = $(DEPKGS)/pthreads/pthreadGCE.dll

BIN_DIR = $(MINGW)/bin

INCLUDES = \
	$(INCLUDE_GCC) \
	$(INCLUDE_MINGW) \
	$(INCLUDE_PTHREADS) \
	$(INCLUDE_APC) \
	$(INCLUDE_ICONS)

HAVES = \
	-DHAVE_MINGW \
	-DHAVE_WIN32 \
	-DHAVE_NISLIB \
	-DHAVE_NET_DRIVER \
	-DHAVE_TEST_DRIVER

DEFINES = \
	-DWIN32 \
	$(HAVES) \
	-D__APCUPSD__



CC = $(BIN_DIR)/mingw32-g++ $(DEFINES) $(INCLUDES)
CXX = $(BIN_DIR)/mingw32-g++ $(DEFINES) $(INCLUDES) 2>&1
WINDRES = $(BIN_DIR)/mingw32-windres

first: all

OBJDIR = .

######################################################################

# Files in src/win32/compat

OBJS_COMPAT = \
	$(OBJDIR)/print.o \
	$(OBJDIR)/compat.o \
	$(OBJDIR)/winapi.o


compat.o:	./compat/compat.cpp
	$(CXX) -c ./compat/compat.cpp -o $(OBJDIR)/compat.o

print.o:	./compat/print.cpp
	$(CXX) -c ./compat/print.cpp -o $(OBJDIR)/print.o

winapi.o:	 ./compat/winapi.c
	$(CXX) -c ./compat/winapi.c -o $(OBJDIR)/winapi.o


######################################################################

# Files in src/win32
OBJS_WIN = \
	$(OBJDIR)/winabout.o \
	$(OBJDIR)/winevents.o \
	$(OBJDIR)/winservice.o \
	$(OBJDIR)/winstat.o \
	$(OBJDIR)/wintray.o \
	$(OBJDIR)/winmain.o \
	$(OBJDIR)/winres.res

$(OBJDIR)/winabout.o:	  ./winabout.cpp
	$(CXX) -c $< -o $@

$(OBJDIR)/winevents.o:	  ./winevents.cpp
	$(CXX) -c $< -o $@

$(OBJDIR)/winmain.o:	  ./winmain.cpp
	$(CXX) -c $< -o $@

$(OBJDIR)/winservice.o:   ./winservice.cpp
	$(CXX) -c $< -o $@

$(OBJDIR)/winstat.o:	  ./winstat.cpp
	$(CXX) -c $< -o $@

$(OBJDIR)/wintray.o:	  ./wintray.cpp
	$(CXX) -c $< -o $@

$(OBJDIR)/winres.res:	  ./winres.rc
	$(WINDRES) $(INCLUDE_ICONS) -O coff $< -o $@

######################################################################


# Files files in src/lib

LIB_OBJS = \
	$(OBJDIR)/apcconfig.o \
	$(OBJDIR)/apcerror.o \
	$(OBJDIR)/apcevents.o \
	$(OBJDIR)/apcexec.o \
	$(OBJDIR)/apcfile.o \
	$(OBJDIR)/apclibnis.o \
	$(OBJDIR)/apclock.o \
	$(OBJDIR)/apclog.o \
	$(OBJDIR)/apcsignal.o \
	$(OBJDIR)/apcstatus.o \
	$(OBJDIR)/asys.o \
	$(OBJDIR)/newups.o \
	$(OBJDIR)/wincompat.o

#
# Rules for generating from ../lib
# 

$(OBJDIR)/apcconfig.o: ../lib/apcconfig.c
	$(CXX) -c $< -o $@

$(OBJDIR)/apcerror.o: ../lib/apcerror.c
	$(CXX) -c $< -o $@
 
$(OBJDIR)/apcevents.o: ../lib/apcevents.c
	$(CXX) -c $< -o $@

$(OBJDIR)/apcexec.o: ../lib/apcexec.c
	$(CXX) -c $< -o $@

$(OBJDIR)/apcfile.o: ../lib/apcfile.c
	$(CXX) -c $< -o $@

$(OBJDIR)/apclibnis.o: ../lib/apclibnis.c
	$(CXX) -c $< -o $@

$(OBJDIR)/apclock.o: ../lib/apclock.c
	$(CXX) -c $< -o $@

$(OBJDIR)/apclog.o: ../lib/apclog.c
	$(CXX) -c $< -o $@

$(OBJDIR)/apcsignal.o: ../lib/apcsignal.c
	$(CXX) -c $< -o $@

$(OBJDIR)/apcstatus.o: ../lib/apcstatus.c
	$(CXX) -c $< -o $@

$(OBJDIR)/asys.o: ../lib/asys.c
	$(CXX) -c $< -o $@

$(OBJDIR)/newups.o: ../lib/newups.c
	$(CXX) -c $< -o $@

$(OBJDIR)/wincompat.o: ../lib/wincompat.c
	$(CXX) -c $< -o $@


######################################################################

# Files in src/drivers
OBJS_DRIVERS = \
	$(OBJDIR)/drivers.o

$(OBJDIR)/drivers.o:  ../drivers/drivers.c
	$(CXX) -c $< -o $@

######################################################################

# Files in src/drivers/test
OBJS_TESTDRV = \
	$(OBJDIR)/testdriver.o

$(OBJDIR)/testdriver.o:  ../drivers/test/testdriver.c
	$(CXX) -c $< -o $@

######################################################################

# Files in src/drivers/net
OBJS_NETDRV = \
	$(OBJDIR)/net.o

$(OBJDIR)/net.o:  ../drivers/net/net.c
	$(CXX) -c $< -o $@

######################################################################


# Files in src
OBJS_SRC = \
	$(OBJDIR)/action.o \
	$(OBJDIR)/apcupsd.o \
	$(OBJDIR)/apcnis.o \
	$(OBJDIR)/device.o \
	$(OBJDIR)/options.o \
	$(OBJDIR)/reports.o

$(OBJDIR)/action.o:  ../action.c
	$(CXX) -c $< -o $@

$(OBJDIR)/apcupsd.o:  ../apcupsd.c
	$(CXX) -c $< -o $@

$(OBJDIR)/apcnis.o:  ../apcnis.c
	$(CXX) -c $< -o $@

$(OBJDIR)/device.o:  ../device.c
	$(CXX) -c $< -o $@

$(OBJDIR)/options.o:  ../options.c
	$(CXX) -c $< -o $@

$(OBJDIR)/reports.o:  ../reports.c
	$(CXX) -c $< -o $@


######################################################################

# apcaccess objects
OBJS_ACCESS = \
	$(OBJDIR)/apcaccess.o

$(OBJDIR)/apcaccess.o:	../apcaccess.c
	$(CXX) -c $< -o $@

######################################################################




APC_OBJS = $(OBJS_SRC) $(LIB_OBJS) $(OBJS_COMPAT) $(OBJS_WIN) \
	   $(OBJS_DRIVERS) $(OBJS_TESTDRV) $(OBJS_NETDRV)

APC_LIBS = \
	-L$(LIB_MINGW) \
	$(LIB_PTHREADS) \
	$(LIB_MINGW)/libuser32.a \
	$(LIB_MINGW)/libgdi32.a \
	$(LIB_MINGW)/libwsock32.a \
	$(LIB_MINGW)/libnetapi32.a

ACCESS_OBJS = $(OBJS_ACCESS) $(LIB_OBJS) $(OBJS_COMPAT)

ACCESS_LIBS = \
	-L$(LIB_MINGW) \
	$(LIB_PTHREADS) \
	$(LIB_MINGW)/libuser32.a \
	$(LIB_MINGW)/libwsock32.a \
	$(LIB_MINGW)/libnetapi32.a

# Targets

all: apcupsd.exe apcaccess.exe

clean:
	rm -f $(OBJDIR)/*.o $(OBJDIR)/apcupsd.exe $(OBJDIR)/winres.res
	rm -f pthreadGCE.dll

# Link the apcupsd daemon executable ...
apcupsd.exe: $(APC_OBJS)
	$(CXX) $(APC_OBJS) $(APC_LIBS) -o $(OBJDIR)/apcupsd.exe
	cp -f $(DEPKGS)/pthreads/pthreadGCE.dll .

apcaccess.exe: $(ACCESS_OBJS)
	$(CXX) $(ACCESS_OBJS) $(ACCESS_LIBS) -o $(OBJDIR)/apcaccess.exe
	cp -f $(DEPKGS)/pthreads/pthreadGCE.dll .
